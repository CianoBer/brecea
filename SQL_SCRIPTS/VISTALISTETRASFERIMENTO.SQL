--DA CORREGGERE A SECONDA DEL MODIF DELLA VERSIONE E RILANCIARE DOPO IL MODIF
ALTER VIEW [dbo].[VISTALISTETRASFERIMENTO] AS 
SELECT 
	TESTELISTATRASF.ESERCIZIO,
	TESTELISTATRASF.CODICELISTA,
	TESTELISTATRASF.NUMEROLISTA,
	TESTELISTATRASF.DATAEMISSIONE,
	TESTELISTATRASF.STATOCHIUSO,
	TESTELISTATRASF.NOTE,
	RIGHELISTATRASF.IDTESTA,
	RIGHELISTATRASF.IDRIGA,
	RIGHELISTATRASF.RIFTESTACOMM,
	RIGHELISTATRASF.DATADISPONIBILITA,
	TESTEORDINIPROD.TIPOCOM,
	TESTEORDINIPROD.ESERCIZIO AS ANNOCOM,
	TESTEORDINIPROD.NUMEROCOM,
	TESTEORDINIPROD.DATAEMISSIONE AS DATAEMISSIONECOM,
	RIGHELISTATRASF.RIFRIGAORD,
	RIGHEORDPROD.CODICEORD,
	(SELECT TIPOORDINE FROM PARAMETRIORDPROD WHERE PARAMETRIORDPROD.CODICE=RIGHEORDPROD.CODICEORD) AS TIPOORD,
	RIGHELISTATRASF.CODART,
	RIGHELISTATRASF.DESCRIZIONEART, 
	RIGHELISTATRASF.RIFRIGAIMP,
	RIGHEORDPROD.VERSIONEDBA,
	RIGHEORDPROD.DATAINIZIORICH,
	RIGHEORDPROD.DATAFINERICH,
	RIGHELISTATRASF.QTATRASFGESTIONE,RIGHELISTATRASF.QTAGESTIONERES,RIGHELISTATRASF.UMGEST,
	RIGHELISTATRASF.QTATRASFPREZZO,RIGHELISTATRASF.UMPREZZO,RIGHELISTATRASF.QTAPREZZOMAN,
	RIGHELISTATRASF.QTATRASF1MAG,RIGHELISTATRASF.QTA1MAGMAN,RIGHELISTATRASF.QTA1MAGRES,
	RIGHELISTATRASF.QTA2MAGMAN,RIGHELISTATRASF.QTATRASF2MAG,RIGHELISTATRASF.QTA2MAGRES,
	RIGHELISTATRASF.QTAGESTIONEDOC,
	RIGHELISTATRASF.UM1MAG AS UM1,
	RIGHELISTATRASF.UM2MAG AS UM2,
	RIGHELISTATRASF.PARTITAASSEGNATA,
	RIGHELISTATRASF.CODCLIFOR,
	(SELECT DSCCONTO1 FROM ANAGRAFICACF WHERE CODCONTO = CODCLIFOR) RAGSOCCLIFOR,
	RIGHELISTATRASF.DEPOSITO,RIGHELISTATRASF.UBICAZIONE,RIGHELISTATRASF.CONTOCDC,
	RIGHELISTATRASF.DEPOSITOCOLL,RIGHELISTATRASF.UBICAZIONECOLL,RIGHELISTATRASF.CONTOCDCCOLL,
	RIGHELISTATRASF.COSTOUNITTRASF,RIGHELISTATRASF.COSTOTOTTRASF,
	RIGHELISTATRASF.COSTOUNITTRASFEURO,RIGHELISTATRASF.COSTOTOTTRASFEURO,
	RIGHELISTATRASF.STATORIGA,RIGHELISTATRASF.NOTE AS NOTERIGA,
	RIGHELISTATRASF.RIFCOMMCLI,
	RIGHELISTATRASF.TIPOMATERIALE,RIGHELISTATRASF.RIFANNOBOLLA,RIGHELISTATRASF.RIFNUMEROBOLLA,
	(TESTELISTATRASF.CODICELISTA + '/' + CAST(TESTELISTATRASF.ESERCIZIO AS VARCHAR(4)) + '/' + RIGHT('00000' + CAST(TESTELISTATRASF.NUMEROLISTA AS VARCHAR(10)),5)) AS RIFLISTA,
	(TESTEORDINIPROD.TIPOCOM + '/' + CAST(TESTEORDINIPROD.ESERCIZIO AS VARCHAR(4)) + '/' + RIGHT('00000' + CAST(TESTEORDINIPROD.NUMEROCOM AS VARCHAR(10)),5) + '/' + RIGHT('00000' + CAST(RIGHELISTATRASF.RIFRIGAORD AS VARCHAR(10)),5)) AS RIFORDINE,
	(TESTEORDINIPROD.TIPOCOM + '/' + CAST(TESTEORDINIPROD.ESERCIZIO AS VARCHAR(4)) + '/' + RIGHT('00000' + CAST(TESTEORDINIPROD.NUMEROCOM AS VARCHAR(10)),5) + '/' + RIGHT('00000' + CAST(RIGHELISTATRASF.RIFRIGAORD AS VARCHAR(10)),5) + '/' + RIGHT('00000' + CAST(RIGHELISTATRASF.RIFRIGAIMP AS VARCHAR(10)),5)) AS RIFIMPEGNO,
	(CAST(RIGHELISTATRASF.RIFANNOBOLLA AS VARCHAR(4)) + '/' + RIGHT('00000' + CAST(RIGHELISTATRASF.RIFNUMEROBOLLA AS VARCHAR(10)),5)) AS RIFBOLLALAV,
	(SELECT OPERAZIONE FROM RIGHECICLOORDINE RC WHERE RC.ANNOBOLLA=RIGHELISTATRASF.RIFANNOBOLLA AND RC.NUMEROBOLLA=RIGHELISTATRASF.RIFNUMEROBOLLA) AS OPERAZIONECLF,
	RIGHEORDPROD.CODART AS CODARTORD,
	RIGHEORDPROD.DESCRIZIONEART AS DESCRIZIONEARTORD,
	RIGHELISTATRASF.STATOPALMARE,
	RIGHELISTATRASF.QTAORIGGEST,
	RIGHELISTATRASF.FORZASALDO
FROM 
	TESTELISTATRASF,
	RIGHELISTATRASF 
	LEFT OUTER JOIN TESTEORDINIPROD ON RIGHELISTATRASF.RIFTESTACOMM=TESTEORDINIPROD.PROGRESSIVO
	LEFT OUTER JOIN RIGHEORDPROD ON RIGHELISTATRASF.RIFTESTACOMM=RIGHEORDPROD.IDTESTA AND RIGHELISTATRASF.RIFRIGAORD=RIGHEORDPROD.IDRIGA
	LEFT OUTER JOIN IMPEGNIORDPROD ON RIGHELISTATRASF.RIFTESTACOMM=IMPEGNIORDPROD.IDTESTA AND RIGHELISTATRASF.RIFRIGAORD=IMPEGNIORDPROD.IDRIGA AND RIGHELISTATRASF.RIFRIGAIMP=IMPEGNIORDPROD.IDIMPEGNO  
WHERE
	TESTELISTATRASF.PROGRESSIVO=RIGHELISTATRASF.IDTESTA

GO