//----------------------------------------------------------------------
//QUERY ARTICOLI DI PROVA AGGIORNATI PER OFA 99999999 DEL 24/06/2011
//SELECT * FROM GESTIONEPREZZIRIGHE WHERE RIFPROGRESSIVO IN (26747,6392)
//----------------------------------------------------------------------
#IF $(PARAMETRO:7)=0
	#DBAPRITAB #0;#1;SELECT * FROM EXTRAPARDOC WHERE AGGPRZSC=1 AND CODICE='$(PARAMETRO:1)'
	#IF $(FINETABELLA)=1
	#ELSE
		#DBAPRITAB #0;#2;SELECT * FROM TESTEDOCUMENTI WHERE PROGRESSIVO=$(PARAMETRO:6)
		#DBLEGGICAMPOSTR #2;CODCLIFOR;CODCLIFOR
		#DBLEGGICAMPO #2;CODLISTINO;CODLISTINO
		#DBCHIUDITAB #2 

		#MESSAGGIO 4132;SI DESIDERA AGGIORNARE LISTINI E SCONTI DI ACQUISTO?
		#IF $(RISPOSTAMESSAGGIO)=6
//			#APRIFILE #1;C:\PIPPO.TXT;OUTPUT
//			#SCRIVIFILE #1;SELECT * FROM RIGHEDOCUMENTI WHERE IDTESTA=$(PARAMETRO:6) AND CODART<>'' AND TIPORIGA NOT IN ('R','D') AND NUMLISTINO=$(CODLISTINO)
//			#CHIUDIFILE #1
			#DBAPRITAB #0;#5;SELECT COUNT(1) AS TOTRIGHE FROM RIGHEDOCUMENTI WHERE IDTESTA=$(PARAMETRO:6) AND CODART<>'' AND TIPORIGA NOT IN ('R','D') AND (NUMLISTINO=$(CODLISTINO) OR NUMLISTINO=0)
			#DBLEGGICAMPO #5;TOTRIGHE;TOTRIGHE
			#DBCHIUDITAB #5 
			#DBAPRITAB #0;#3;SELECT * FROM RIGHEDOCUMENTI WHERE IDTESTA=$(PARAMETRO:6) AND CODART<>'' AND TIPORIGA NOT IN ('R','D') AND (NUMLISTINO=$(CODLISTINO) OR NUMLISTINO=0)
			#LET RIGA=1
			#DBPRIMO #3
			#DO
				#DBLEGGICAMPOSTR #3;CODART;CODART
				#DBLEGGICAMPOSTR #3;UMPREZZO;UMPREZZO
				#DBLEGGICAMPO #3;NUMLISTINO;NUMLISTINO
				#DBLEGGICAMPO #3;PREZZOUNITLORDO;PREZZOUNITLORDO
				#DBLEGGICAMPOSTR #3;SCONTIESTESI;SCONTIESTESI

				//PREZZI E SCONTI PARTICOLARI
				#DBAPRITAB #0;#4;SELECT * FROM VISTAGESTIONEPREZZI WHERE CODCLIFOR='$(CODCLIFOR)' AND CODART='$(CODART)' AND NRLISTINO=$(CODLISTINO)
				#IF $(FINETABELLA)=1
					#DBAPRITAB #0;#7;SELECT MAX(IDRIGA)+1 AS NEWRIGA,MAX(RIFPROGRESSIVO)+1 AS NEWPROGRESSIVO FROM GESTIONEPREZZIRIGHE
					#DBLEGGICAMPO #7;NEWPROGRESSIVO;NEWPROGRESSIVO
					#DBLEGGICAMPO #7;NEWRIGA;NEWRIGA
					#DBCHIUDITAB #7 
					#DBESEGUISQL #0;SET DATEFORMAT DMY INSERT INTO GESTIONEPREZZI(PROGRESSIVO,CODGRUPPOPREZZICF,CODCLIFOR,CODART,CODGRUPPOPREZZIMAG,INIZIOVALIDITA,FINEVALIDITA,USANRLISTINO,TIPOARROT,ARROTALIRE,ARROTAEURO,CODARTRIC,UTENTEMODIFICA,DATAMODIFICA,PROGRESSIVOCTR) VALUES($(NEWPROGRESSIVO),0,'$(CODCLIFOR)','$(CODART)',0,'01/01/1990','31/12/2099',1,'N',0,0,'$(CODART)','$(UTENTE)',GETDATE(),0)
					#DBESEGUISQL #0;INSERT INTO GESTIONEPREZZIRIGHE(IDRIGA,RIFPROGRESSIVO,NRLISTINO,UM,QTAMINIMA,PREZZO_MAGG,PREZZO_MAGGEURO,SCONTO_UNICO,SCONTO_AGGIUNTIVO,TIPO,UTENTEMODIFICA,DATAMODIFICA,TP_QTASCONTO,TP_QTACOEFF) VALUES($(NEWRIGA),$(NEWPROGRESSIVO),$(CODLISTINO),'$(UMPREZZO)',0,0,0,'$(SCONTIESTESI)',NULL,0,'$(UTENTE)',GETDATE(),NULL,NULL)
				#ELSE
					//#IF $(SCONTIESTESI)==
					//#ELSE
						#DBAPRITAB #0;#8;SELECT * FROM VISTAGESTIONEPREZZI WHERE CODCLIFOR='$(CODCLIFOR)' AND CODART='$(CODART)' AND NRLISTINO=$(CODLISTINO) AND SCONTO_UNICO='$(SCONTIESTESI)'
							#IF $(FINETABELLA)=1
								#DBLEGGICAMPO #4;PROGRESSIVO;PROGRESSIVO
								#DBLEGGICAMPO #4;IDRIGA;IDRIGA
								#DBESEGUISQL #0;UPDATE GESTIONEPREZZIRIGHE SET SCONTO_UNICO='$(SCONTIESTESI)',SCONTO_AGGIUNTIVO=NULL,UTENTEMODIFICA='$(UTENTE)',DATAMODIFICA=GETDATE() WHERE RIFPROGRESSIVO=$(PROGRESSIVO) AND IDRIGA=$(IDRIGA)
							#ENDIF
						#DBCHIUDITAB #8
					//#ENDIF
				#ENDIF
				#DBCHIUDITAB #4
				
				//LISTINI
				#DBAPRITAB #0;#6;SELECT * FROM LISTINIARTICOLI WHERE CODART='$(CODART)' AND NRLISTINO=$(CODLISTINO) AND UM='$(UMPREZZO)'
				#IF $(FINETABELLA)=1
					#DBESEGUISQL #0;INSERT INTO LISTINIARTICOLI(CODART,NRLISTINO,UM,PREZZO,PREZZOEURO,UTENTEMODIFICA,DATAMODIFICA,DELTAINCREMENTO) VALUES('$(CODART)',$(CODLISTINO),'$(UMPREZZO)',$(PREZZOUNITLORDO),$(PREZZOUNITLORDO),'$(UTENTE)',GETDATE(),0) 
				#ELSE
					#DBAPRITAB #0;#9;SELECT * FROM LISTINIARTICOLI WHERE CODART='$(CODART)' AND NRLISTINO=$(CODLISTINO) AND UM='$(UMPREZZO)' AND PREZZOEURO=$(PREZZOUNITLORDO)
						#IF $(FINETABELLA)=1
							#DBESEGUISQL #0;UPDATE LISTINIARTICOLI SET PREZZO=$(PREZZOUNITLORDO),PREZZOEURO=$(PREZZOUNITLORDO),UTENTEMODIFICA='$(UTENTE)',DATAMODIFICA=GETDATE() WHERE CODART='$(CODART)' AND NRLISTINO=$(CODLISTINO) AND UM='$(UMPREZZO)'
						#ENDIF
					#DBCHIUDITAB #9
				#ENDIF
				#DBCHIUDITAB #6
				
				#LET RIGA={$(RIGA)+1}
				#DBSUCCESSIVO #3 
			#LOOP $(RIGA)>$(TOTRIGHE)
			#DBCHIUDITAB #3 
		#ENDIF
	#ENDIF
	#DBCHIUDITAB #1 
#ENDIF