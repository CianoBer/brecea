[VALUTA]

#STAMPA SEL_WIP;1

#DISABILITAVALUTAZIONE 1

#DISABILITAVALUTAZIONE 0

#IF $(DESCRWIP)==
	#LETS PARAMETRO=
#else
	#lets parametro=1=1
#ENDIF

#IF $(PARAMETRO)<>
	#DBCONNETTI #0
	#DISABILITAVALUTAZIONE 1
	#lets barra=/
	#lets meno=-
	#SOSTITUISCI DATACALCOLO;barra;meno;DATACALCOLO
	#DISABILITAVALUTAZIONE 0

		#MESSAGGIO 4;VUOI PROCEDERE CON L'ELABORAZIONE WIP ?
		
		#IF $(RISPOSTAMESSAGGIO)==6
			#DBESEGUISQL #0;DELETE TESTA_WIP WHERE DESCRIZIONEWIP='$(DESCRWIP)'
			#DBESEGUISQL #0;DELETE RIGHE_WIP WHERE DESCRIZIONEWIP='$(DESCRWIP)'


			
			#DISABILITAVALUTAZIONE 1

			#DBAPRITAB #0;#1;SELECT IDTESTA,IDRIGA,RIFCOMMCLI,CODART FROM RIGHEORDPROD WHERE DATAEMISSIONE<={d'$(DATACALCOLO)'} AND (((select COUNT(RIFPROGRESSIVO) from STORICOMOVORDPROD St_OP inner join STORICOMOVPROD ST_M on ST_M.PROGRESSIVO=St_OP.RIFPROGRESSIVO where St_Op.riftesta=idtesta and St_OP.rifriga=idriga and datamov>{d'$(DATACALCOLO)'} AND STATOORDINE=3)>0 AND STATOORDINE=3) OR (STATOORDINE<3)) AND IDTESTA IN (SELECT PROGRESSIVO FROM TESTEORDINIPROD) 


			#DBPRIMO #1

			#DBLEGGICAMPO #1;IDTESTA;IDTESTACOMM

			#DBESEGUISQL #0;INSERT INTO TESTA_WIP select '$(DESCRWIP)',{d'$(DATACALCOLO)'},0,idtesta,'$(UTENTE)',GETDATE() FROM RIGHEORDPROD WHERE DATAEMISSIONE<={d'$(DATACALCOLO)'} AND (((select COUNT(RIFPROGRESSIVO) from STORICOMOVORDPROD St_OP inner join STORICOMOVPROD ST_M on ST_M.PROGRESSIVO=St_OP.RIFPROGRESSIVO where St_Op.riftesta=idtesta and St_OP.rifriga=idriga and datamov>{d'2011-03-31'} AND STATOORDINE=3)>0 AND STATOORDINE=3) OR (STATOORDINE<3)) AND IDTESTA IN (SELECT PROGRESSIVO FROM TESTEORDINIPROD) group by idtesta
			
			#LET CONTA=1
			
			#DO
				#MOSTRAMSGSTATO STO ELABORANDO IL RECORD N. $(CONTA) DELL'ARTICOLO $(CODART)
				#DBLEGGICAMPO #1;IDTESTA;IDTESTA
				#DBLEGGICAMPO #1;IDRIGA;IDRIGA
				#DBLEGGICAMPOSTR #1;RIFCOMMCLI;RIFCOMMCLI
				#DBLEGGICAMPOSTR #1;CODART;CODARTORD

				#LET TOTORDINE_A=0

				#DBAPRITAB #0;#2;select datamov,isnull(sti.costototmoveuro,0) as pippo, sti.* from storicomovimpprod sti inner join storicomovprod stm on stm.progressivo=sti.rifprogressivo where sti.riftesta=$(IDTESTA) and sti.rifriga=$(IDRIGA) AND DATAMOV<={d'$(DATACALCOLO)'}			
				#DBPRIMO #2
				#DO 
					#DBLEGGICAMPOSTR #2;CODART;CODART
					#DBLEGGICAMPO #2;QTAMOV1MAG;QTA1UM
					#DBLEGGICAMPO #2;pippo;STORICOIMP
					
					#LET TOTORDINE_A=$(TOTORDINE_A)+$(STORICOIMP)
					
					#DBSUCCESSIVO #2	
				#LOOP $(FINETABELLA)==1
				#DBCHIUDITAB #2



				#LET TOTORDINE_B=0
				#LET TOTORDINEINT_B=0
				#LET TOTORDINEEST_B=0
				#LETS TOTORDINE_B_BOLLE=

				#DBAPRITAB #0;#2;SELECT * FROM VISTASTORICOAVANZAMENTI WHERE IDTESTACOMM=$(IDTESTA) AND IDRIGACOMM=$(IDRIGA) AND DATAMOV<={d'$(DATACALCOLO)'}
				#DBPRIMO #2
				#IF $(FINETABELLA)<>1
					#DO
						#DBLEGGICAMPO #2;COSTOTOTALEEURO;TOTAVANZAMENTI
						#DBLEGGICAMPO #2;COSTOTOTALEINTERNOEURO;TOTAVANZAMENTIINT
						#DBLEGGICAMPO #2;COSTOTOTALEESTERNOEURO;TOTAVANZAMENTIEST
						#DBLEGGICAMPO #2;ANNOBOLLA;ANNOBOLLA
						#DBLEGGICAMPO #2;NUMEROBOLLA;NUMEROBOLLA
						
						#LET TOTORDINE_B=$(TOTORDINE_B)+$(TOTAVANZAMENTI)
						#LET TOTORDINEINT_B=$(TOTORDINEINT_B)+$(TOTAVANZAMENTIINT)
						#LET TOTORDINEEST_B=$(TOTORDINEEST_B)+$(TOTAVANZAMENTIEST)
						
						#CONCATENASTR TOTORDINE_B_BOLLE;"$(ANNOBOLLA)";"/";"$(NUMEROBOLLA)";" - "
						
						#DBSUCCESSIVO #2
					
					#LOOP $(FINETABELLA)==1
				#ENDIF
				
				#DBCHIUDITAB #2

				#LET TOTORDINE_C=0

				#DBAPRITAB #0;#2;select datamov,isnull(sto.costototmoveuro,0) as pippo, sto.* from storicomovordprod sto inner join storicomovprod stm on stm.progressivo=sto.rifprogressivo where sto.riftesta=$(IDTESTA) and sto.rifriga=$(IDRIGA) AND STM.TIPOMOV IN (0, 2) AND DATAMOV<={d'$(DATACALCOLO)'}
				#DBPRIMO #2
				
				#IF $(FINETABELLA)<>1
					#DO 
						#DBLEGGICAMPOSTR #2;CODART;CODART
						#DBLEGGICAMPO #2;qtamov1mag;QTA1UM
						#DBLEGGICAMPO #2;pippo;STORICOIMP

						#LET TOTORDINE_C=$(TOTORDINE_C)+$(STORICOIMP)

						#DBCHIUDITAB #3
						#DBSUCCESSIVO #2	
					#LOOP $(FINETABELLA)==1
				#ENDIF
				
				#DBCHIUDITAB #2
				
				#IF $(TOTORDINE_A)==
					#LETS TOTORDINE_A=0
				#ENDIF
				#IF $(TOTORDINE_B)==
					#LETS TOTORDINE_B=0
				#ENDIF
				#IF $(TOTORDINEINT_B)==
					#LETS TOTORDINEINT_B=0
				#ENDIF
				#IF $(TOTORDINEEST_B)==
					#LETS TOTORDINEEST_B=0
				#ENDIF
				#IF $(TOTORDINE_C)==
					#LETS TOTORDINE_C=0
				#ENDIF

				#LET TOTORDINE_GEN=$(TOTORDINE_A)+$(TOTORDINE_B)-$(TOTORDINE_C)

				#IF $(TOTORDINE_GEN)== | $(TOTORDINE_GEN)<0
					#LETS TOTORDINE_GEN=0
				#ENDIF
				
				#DBESEGUISQL #0;INSERT INTO RIGHE_WIP VALUES ('$(DESCRWIP)',$(IDTESTA),$(IDRIGA),'$(RIFCOMMCLI)','$(CODARTORD)',$(TOTORDINE_A),$(TOTORDINE_B),'$(TOTORDINE_B_BOLLE)',$(TOTORDINEINT_B),$(TOTORDINEEST_B),$(TOTORDINE_C),$(TOTORDINE_GEN),'$(UTENTE)',GETDATE(),0,0,0)

				#DBSUCCESSIVO #1
				
				#DBLEGGICAMPO #1;IDTESTA;IDTESTA
				#DBLEGGICAMPO #1;IDRIGA;IDRIGA
				
				#CANCELLAMSGSTATO
			#LOOP $(FINETABELLA)==1

			#DBESEGUISQL #0;UPDATE RIGHE_WIP SET WIP_MAT=(CASE WHEN TOTALEPX_GEN >= TOTALEPX_A THEN TOTALEPX_A ELSE TOTALEPX_GEN END) WHERE DESCRIZIONEWIP='$(DESCRWIP)'
			#DBESEGUISQL #0;UPDATE RIGHE_WIP SET WIP_LAVINT=(CASE WHEN (TOTALEPX_GEN - (CASE WHEN TOTALEPX_GEN >= TOTALEPX_A THEN TOTALEPX_A ELSE TOTALEPX_GEN END)) >= TOTALEPXINT_B THEN TOTALEPXINT_B ELSE (TOTALEPX_GEN - (CASE WHEN TOTALEPX_GEN >= TOTALEPX_A THEN TOTALEPX_A ELSE TOTALEPX_GEN END)) END) WHERE DESCRIZIONEWIP='$(DESCRWIP)'
			#DBESEGUISQL #0;UPDATE RIGHE_WIP SET WIP_LAVEST=(CASE WHEN (TOTALEPX_GEN - (CASE WHEN TOTALEPX_GEN >= TOTALEPX_A THEN TOTALEPX_A ELSE TOTALEPX_GEN END) - (CASE WHEN (TOTALEPX_GEN - (CASE WHEN TOTALEPX_GEN >= TOTALEPX_A THEN TOTALEPX_A ELSE TOTALEPX_GEN END)) >= TOTALEPXINT_B THEN TOTALEPXINT_B ELSE (TOTALEPX_GEN - (CASE WHEN TOTALEPX_GEN >= TOTALEPX_A THEN TOTALEPX_A ELSE TOTALEPX_GEN END) ) END) ) >= TOTALEPXEST_B THEN TOTALEPXEST_B ELSE (TOTALEPX_GEN - (CASE WHEN TOTALEPX_GEN >= TOTALEPX_A THEN TOTALEPX_A ELSE TOTALEPX_GEN END) - (CASE WHEN (TOTALEPX_GEN - (CASE WHEN TOTALEPX_GEN >= TOTALEPX_A THEN TOTALEPX_A ELSE TOTALEPX_GEN END)) >= TOTALEPXINT_B THEN TOTALEPXINT_B ELSE (TOTALEPX_GEN - (CASE WHEN TOTALEPX_GEN >= TOTALEPX_A THEN TOTALEPX_A ELSE TOTALEPX_GEN END) ) END) ) END) WHERE DESCRIZIONEWIP='$(DESCRWIP)'

			#MESSAGGIO 0;ELABORAZIONE CONCLUSA.
		#ELSE
			#MESSAGGIO 0;ELABORAZIONE ANNULLATA.
		#ENDIF

	#DBDISCONNETTI #0
	#CANCELLAMSGSTATO
#ELSE
	#MESSAGGIO 0;IL CAMPO DESCRIZIONE NON PUO' ESSERE VUOTO !
#ENDIF

